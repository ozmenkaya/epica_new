{% extends "base.html" %}
{% load i18n %}

{% block title %}AI Assistant - Epica{% endblock %}

{% block extra_head %}
<style>
    /* Chat styles remain unchanged */
</style>
{% endblock %}

{% block content %}
<div style="display: none;">
    {% csrf_token %}
</div>
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Conversations Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{% trans "Sohbetler" %}</h5>
                    <button class="btn btn-sm btn-primary" id="newChatBtn">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <!-- Search Box -->
                    <div class="p-2 border-bottom">
                        <input type="text" 
                               class="form-control form-control-sm" 
                               id="searchConversations" 
                               placeholder="{% trans 'Sohbetlerde ara...' %}">
                    </div>
                    <div class="list-group list-group-flush" id="conversationsList">
                        {% for conv in conversations %}
                        <div class="list-group-item list-group-item-action conversation-item d-flex justify-content-between align-items-center" 
                             data-conversation-id="{{ conv.id }}"
                             data-title="{{ conv.title|lower }}">
                            <a href="#" class="flex-grow-1 text-decoration-none text-dark conversation-link">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">{{ conv.title|truncatechars:30 }}</h6>
                                    <small>{{ conv.updated_at|date:"d M" }}</small>
                                </div>
                            </a>
                            <button class="btn btn-sm btn-link text-danger delete-conversation-btn" 
                                    data-conversation-id="{{ conv.id }}"
                                    title="{% trans 'Sil' %}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% empty %}
                        <div class="p-3 text-muted text-center" id="noConversationsMsg">
                            {% trans "Henüz sohbet yok" %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Info Card -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">{% trans "AI Asistan Neler Yapabilir?" %}</h6>
                    <ul class="small mb-0">
                        <li>{% trans "Talep ve tekliflerinizi sorgula" %}</li>
                        <li>{% trans "İstatistik ve analiz yap" %}</li>
                        <li>{% trans "Talep durumu güncelle" %}</li>
                        <li>{% trans "Tedarikçi bilgisi ara" %}</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-9">
            <div class="card" style="height: calc(100vh - 120px);">
                <div class="card-header">
                    <h5 class="mb-0" id="chatTitle">{% trans "AI Asistan" %}</h5>
                </div>
                <div class="card-body d-flex flex-column" style="height: 100%;">
                    <!-- Messages Container -->
                    <div id="messagesContainer" class="flex-grow-1 overflow-auto mb-3" style="max-height: calc(100% - 80px);">
                        <div id="welcomeMessage" class="text-center text-muted mt-5">
                            <i class="bi bi-robot" style="font-size: 3rem;"></i>
                            <h4 class="mt-3">{% trans "Merhaba! Size nasıl yardımcı olabilirim?" %}</h4>
                            <p>{% trans "Talepler, teklifler, tedarikçiler hakkında soru sorabilir veya işlem yapabilirsiniz." %}</p>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="mt-auto">
                        <form id="chatForm">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="messageInput" 
                                       placeholder="{% trans 'Mesajınızı yazın...' %}"
                                       autocomplete="off">
                                <button class="btn btn-primary" type="submit" id="sendBtn">
                                    <i class="bi bi-send"></i> {% trans "Gönder" %}
                                </button>
                            </div>
                        </form>
                        <div class="text-muted small mt-2">
                            {% trans "AI asistan beta aşamasındadır. Önemli kararlar için doğrulamayı unutmayın." %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message {
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    max-width: 80%;
}

.message-user {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
}

.message-assistant {
    background-color: #f8f9fa;
    color: #212529;
    border: 1px solid #dee2e6;
}

.message-content {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.message-content a {
    color: inherit;
    font-weight: 500;
}

.message-user .message-content a {
    color: white;
}

.message-assistant .message-content a {
    color: #007bff;
}

.message-assistant .message-content a:hover {
    color: #0056b3;
}

.conversation-item.active {
    background-color: #007bff;
    color: white;
}

.typing-indicator {
    display: inline-block;
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
}

.typing-indicator span {
    height: 8px;
    width: 8px;
    background-color: #6c757d;
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.feedback-buttons {
    margin-top: 0.5rem;
    text-align: right;
}

.feedback-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.feedback-btn:disabled {
    cursor: not-allowed;
}

#searchConversations {
    width: 100%;
    padding: 0.5rem;
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    font-size: 0.875rem;
}

#searchConversations:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.conversation-item {
    position: relative;
    display: flex;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
    cursor: pointer;
    transition: background-color 0.2s;
}

.conversation-link {
    flex: 1;
    text-decoration: none;
    color: inherit;
}

.delete-conversation-btn {
    background: none;
    border: none;
    color: #dc3545;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
    font-size: 1rem;
}

.conversation-item:hover .delete-conversation-btn {
    opacity: 1;
}

.delete-conversation-btn:hover {
    color: #bd2130;
    background-color: rgba(220, 53, 69, 0.1);
    border-radius: 0.25rem;
}

.conversation-item:hover {
    background-color: #f8f9fa;
}

.conversation-item.active {
    background-color: #007bff;
    color: white;
}

.conversation-item.active .delete-conversation-btn {
    color: white;
}

.conversation-item.active .delete-conversation-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}
</style>

<script>
let currentConversationId = null;

// New chat button
document.getElementById('newChatBtn').addEventListener('click', function() {
    fetch('{% url "ai_assistant:chat" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            currentConversationId = data.conversation_id;
            clearMessages();
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error creating conversation:', error);
        alert('Failed to create new conversation');
    });
});

// Search conversations
document.getElementById('searchConversations').addEventListener('input', function(e) {
    const searchQuery = e.target.value.toLowerCase().trim();
    const conversations = document.querySelectorAll('.conversation-item');
    let visibleCount = 0;
    
    conversations.forEach(item => {
        const title = item.dataset.title || '';
        if (title.includes(searchQuery)) {
            item.style.display = '';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    // Show/hide "no results" message
    let noResults = document.getElementById('noSearchResults');
    if (visibleCount === 0 && searchQuery !== '') {
        if (!noResults) {
            noResults = document.createElement('div');
            noResults.id = 'noSearchResults';
            noResults.className = 'text-muted text-center py-3';
            noResults.textContent = 'Sonuç bulunamadı';
            document.querySelector('.conversations-list').appendChild(noResults);
        }
        noResults.style.display = 'block';
    } else if (noResults) {
        noResults.style.display = 'none';
    }
});

// Delete conversation
document.addEventListener('click', function(e) {
    if (e.target.closest('.delete-conversation-btn')) {
        e.stopPropagation();
        e.preventDefault();
        
        const btn = e.target.closest('.delete-conversation-btn');
        const convId = btn.dataset.conversationId;
        const conversationItem = btn.closest('.conversation-item');
        
        if (confirm('Bu sohbeti silmek istediğinizden emin misiniz?')) {
            const url = `{% url "ai_assistant:delete_conversation" 0 %}`.replace('0', convId);
            fetch(url, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Remove from DOM
                    conversationItem.remove();
                    
                    // If this was the active conversation, clear chat
                    if (currentConversationId == convId) {
                        currentConversationId = null;
                        document.getElementById('messagesContainer').innerHTML = '<div class="text-muted text-center py-5">Sohbet seçin veya yeni bir sohbet başlatın</div>';
                        document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
                    }
                    
                    // Show success message briefly
                    const container = document.getElementById('messagesContainer');
                    const notice = document.createElement('div');
                    notice.className = 'alert alert-success alert-dismissible fade show';
                    notice.innerHTML = '<i class="bi bi-check-circle me-2"></i>Sohbet silindi';
                    container.insertBefore(notice, container.firstChild);
                    setTimeout(() => notice.remove(), 3000);
                } else {
                    alert('Sohbet silinirken bir hata oluştu');
                }
            })
            .catch(error => {
                console.error('Error deleting conversation:', error);
                alert('Sohbet silinirken bir hata oluştu');
            });
        }
    }
});

// Load conversation
document.querySelectorAll('.conversation-link').forEach(link => {
    link.addEventListener('click', function(e) {
        e.preventDefault();
        const item = this.closest('.conversation-item');
        const convId = item.dataset.conversationId;
        loadConversation(convId);
        
        // Mark as active
        document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
        item.classList.add('active');
    });
});

// Send message
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    if (!currentConversationId) {
        // Create new conversation first
        fetch('{% url "ai_assistant:chat" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                currentConversationId = data.conversation_id;
                sendMessage(message);
            }
        })
        .catch(error => {
            console.error('Error creating conversation:', error);
            alert('Failed to create conversation');
        });
    } else {
        sendMessage(message);
    }
    
    input.value = '';
});

function sendMessage(message) {
    // Show user message
    appendMessage('user', message);
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to server
    const url = `{% url "ai_assistant:send_message" 0 %}`.replace('0', currentConversationId);
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        hideTypingIndicator();
        
        if (data.success) {
            appendMessage('assistant', data.message.content, data.message.id);
            
            // Show function calls if any
            if (data.message.function_calls && data.message.function_calls.length > 0) {
                data.message.function_calls.forEach(fc => {
                    console.log('Function called:', fc);
                });
            }
        } else {
            appendMessage('assistant', 'Error: ' + data.error);
        }
    })
    .catch(error => {
        hideTypingIndicator();
        appendMessage('assistant', 'Error: ' + error.message);
        console.error('Send message error:', error);
    });
}

function loadConversation(convId) {
    currentConversationId = convId;
    clearMessages();
    
    const url = `{% url "ai_assistant:get_conversation" 0 %}`.replace('0', convId);
    fetch(url)
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            document.getElementById('chatTitle').textContent = data.conversation.title;
            data.messages.forEach(msg => {
                appendMessage(msg.role, msg.content, msg.id);
            });
        }
    })
    .catch(error => {
        console.error('Load conversation error:', error);
    });
}

function appendMessage(role, content, messageId = null) {
    const container = document.getElementById('messagesContainer');
    const welcome = document.getElementById('welcomeMessage');
    if (welcome) welcome.remove();
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${role}`;
    
    // Convert markdown links to HTML links
    let processedContent = escapeHtml(content);
    
    // Convert [text](url) to clickable links
    processedContent = processedContent.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-decoration-underline">$1</a>'
    );
    
    // Convert plain URLs to clickable links (if not already in a link)
    processedContent = processedContent.replace(
        /(?<!href="|">)(https?:\/\/[^\s<]+)/g,
        '<a href="$1" target="_blank" rel="noopener noreferrer" class="text-decoration-underline">$1</a>'
    );
    
    let messageHtml = `<div class="message-content">${processedContent}</div>`;
    
    // Add feedback buttons for assistant messages
    if (role === 'assistant' && messageId) {
        messageHtml += `
            <div class="feedback-buttons mt-2" data-message-id="${messageId}">
                <button class="btn btn-sm btn-outline-success feedback-btn" data-feedback="positive" title="Yararlı">
                    <i class="bi bi-hand-thumbs-up"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger feedback-btn ms-1" data-feedback="negative" title="Yararlı değil">
                    <i class="bi bi-hand-thumbs-down"></i>
                </button>
            </div>
        `;
    }
    
    messageDiv.innerHTML = messageHtml;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function showTypingIndicator() {
    const container = document.getElementById('messagesContainer');
    const indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'typing-indicator';
    indicator.innerHTML = '<span></span><span></span><span></span>';
    container.appendChild(indicator);
    container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

function clearMessages() {
    document.getElementById('messagesContainer').innerHTML = '';
}

function getCookie(name) {
    // Try to get CSRF token from hidden input first (most reliable for Django)
    if (name === 'csrftoken') {
        const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (tokenInput) {
            return tokenInput.value;
        }
    }
    
    // Fallback to cookie
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Feedback submission
document.addEventListener('click', function(e) {
    if (e.target.closest('.feedback-btn')) {
        const btn = e.target.closest('.feedback-btn');
        const feedbackType = btn.getAttribute('data-feedback');
        const container = btn.closest('.feedback-buttons');
        const messageId = container.getAttribute('data-message-id');
        
        submitFeedback(messageId, feedbackType, container);
    }
});

function submitFeedback(messageId, feedbackType, container) {
    const url = `{% url "ai_assistant:message_feedback" 0 %}`.replace('0', messageId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            feedback: feedbackType
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Disable all buttons and highlight selected
            container.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('btn-outline-success', 'btn-outline-danger');
                
                if (btn.getAttribute('data-feedback') === feedbackType) {
                    btn.classList.add(feedbackType === 'positive' ? 'btn-success' : 'btn-danger');
                } else {
                    btn.classList.add('btn-secondary');
                }
            });
        }
    })
    .catch(error => {
        console.error('Feedback submission error:', error);
        alert('Geri bildirim gönderilemedi');
    });
}
</script>
{% endblock %}
