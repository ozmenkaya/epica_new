{% extends "base.html" %}
{% load i18n %}

{% block title %}AI Assistant - Epica{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Conversations Sidebar -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{% trans "Sohbetler" %}</h5>
                    <button class="btn btn-sm btn-primary" id="newChatBtn">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="conversationsList">
                        {% for conv in conversations %}
                        <a href="#" class="list-group-item list-group-item-action conversation-item" 
                           data-conversation-id="{{ conv.id }}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ conv.title|truncatechars:30 }}</h6>
                                <small>{{ conv.updated_at|date:"d M" }}</small>
                            </div>
                        </a>
                        {% empty %}
                        <div class="p-3 text-muted text-center">
                            {% trans "Henüz sohbet yok" %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Info Card -->
            <div class="card mt-3">
                <div class="card-body">
                    <h6 class="card-title">{% trans "AI Asistan Neler Yapabilir?" %}</h6>
                    <ul class="small mb-0">
                        <li>{% trans "Talep ve tekliflerinizi sorgula" %}</li>
                        <li>{% trans "İstatistik ve analiz yap" %}</li>
                        <li>{% trans "Talep durumu güncelle" %}</li>
                        <li>{% trans "Tedarikçi bilgisi ara" %}</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-9">
            <div class="card" style="height: calc(100vh - 120px);">
                <div class="card-header">
                    <h5 class="mb-0" id="chatTitle">{% trans "AI Asistan" %}</h5>
                </div>
                <div class="card-body d-flex flex-column" style="height: 100%;">
                    <!-- Messages Container -->
                    <div id="messagesContainer" class="flex-grow-1 overflow-auto mb-3" style="max-height: calc(100% - 80px);">
                        <div id="welcomeMessage" class="text-center text-muted mt-5">
                            <i class="bi bi-robot" style="font-size: 3rem;"></i>
                            <h4 class="mt-3">{% trans "Merhaba! Size nasıl yardımcı olabilirim?" %}</h4>
                            <p>{% trans "Talepler, teklifler, tedarikçiler hakkında soru sorabilir veya işlem yapabilirsiniz." %}</p>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="mt-auto">
                        <form id="chatForm">
                            <div class="input-group">
                                <input type="text" 
                                       class="form-control" 
                                       id="messageInput" 
                                       placeholder="{% trans 'Mesajınızı yazın...' %}"
                                       autocomplete="off">
                                <button class="btn btn-primary" type="submit" id="sendBtn">
                                    <i class="bi bi-send"></i> {% trans "Gönder" %}
                                </button>
                            </div>
                        </form>
                        <div class="text-muted small mt-2">
                            {% trans "AI asistan beta aşamasındadır. Önemli kararlar için doğrulamayı unutmayın." %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.message {
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    max-width: 80%;
}

.message-user {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
}

.message-assistant {
    background-color: #f8f9fa;
    color: #212529;
    border: 1px solid #dee2e6;
}

.message-content {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.conversation-item.active {
    background-color: #007bff;
    color: white;
}

.typing-indicator {
    display: inline-block;
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
}

.typing-indicator span {
    height: 8px;
    width: 8px;
    background-color: #6c757d;
    border-radius: 50%;
    display: inline-block;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.feedback-buttons {
    margin-top: 0.5rem;
    text-align: right;
}

.feedback-btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.feedback-btn:disabled {
    cursor: not-allowed;
}
</style>

<script>
let currentConversationId = null;

// New chat button
document.getElementById('newChatBtn').addEventListener('click', function() {
    fetch('{% url "ai_assistant:chat" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            currentConversationId = data.conversation_id;
            clearMessages();
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error creating conversation:', error);
        alert('Failed to create new conversation');
    });
});

// Load conversation
document.querySelectorAll('.conversation-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const convId = this.dataset.conversationId;
        loadConversation(convId);
        
        // Mark as active
        document.querySelectorAll('.conversation-item').forEach(el => el.classList.remove('active'));
        this.classList.add('active');
    });
});

// Send message
document.getElementById('chatForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    if (!currentConversationId) {
        // Create new conversation first
        fetch('{% url "ai_assistant:chat" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                currentConversationId = data.conversation_id;
                sendMessage(message);
            }
        })
        .catch(error => {
            console.error('Error creating conversation:', error);
            alert('Failed to create conversation');
        });
    } else {
        sendMessage(message);
    }
    
    input.value = '';
});

function sendMessage(message) {
    // Show user message
    appendMessage('user', message);
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to server
    const url = `{% url "ai_assistant:send_message" 0 %}`.replace('0', currentConversationId);
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        hideTypingIndicator();
        
        if (data.success) {
            appendMessage('assistant', data.message.content, data.message.id);
            
            // Show function calls if any
            if (data.message.function_calls && data.message.function_calls.length > 0) {
                data.message.function_calls.forEach(fc => {
                    console.log('Function called:', fc);
                });
            }
        } else {
            appendMessage('assistant', 'Error: ' + data.error);
        }
    })
    .catch(error => {
        hideTypingIndicator();
        appendMessage('assistant', 'Error: ' + error.message);
        console.error('Send message error:', error);
    });
}

function loadConversation(convId) {
    currentConversationId = convId;
    clearMessages();
    
    const url = `{% url "ai_assistant:get_conversation" 0 %}`.replace('0', convId);
    fetch(url)
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            document.getElementById('chatTitle').textContent = data.conversation.title;
            data.messages.forEach(msg => {
                appendMessage(msg.role, msg.content, msg.id);
            });
        }
    })
    .catch(error => {
        console.error('Load conversation error:', error);
    });
}

function appendMessage(role, content, messageId = null) {
    const container = document.getElementById('messagesContainer');
    const welcome = document.getElementById('welcomeMessage');
    if (welcome) welcome.remove();
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${role}`;
    
    let messageHtml = `<div class="message-content">${escapeHtml(content)}</div>`;
    
    // Add feedback buttons for assistant messages
    if (role === 'assistant' && messageId) {
        messageHtml += `
            <div class="feedback-buttons mt-2" data-message-id="${messageId}">
                <button class="btn btn-sm btn-outline-success feedback-btn" data-feedback="positive" title="Yararlı">
                    <i class="bi bi-hand-thumbs-up"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger feedback-btn ms-1" data-feedback="negative" title="Yararlı değil">
                    <i class="bi bi-hand-thumbs-down"></i>
                </button>
            </div>
        `;
    }
    
    messageDiv.innerHTML = messageHtml;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function showTypingIndicator() {
    const container = document.getElementById('messagesContainer');
    const indicator = document.createElement('div');
    indicator.id = 'typingIndicator';
    indicator.className = 'typing-indicator';
    indicator.innerHTML = '<span></span><span></span><span></span>';
    container.appendChild(indicator);
    container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

function clearMessages() {
    document.getElementById('messagesContainer').innerHTML = '';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Feedback submission
document.addEventListener('click', function(e) {
    if (e.target.closest('.feedback-btn')) {
        const btn = e.target.closest('.feedback-btn');
        const feedbackType = btn.getAttribute('data-feedback');
        const container = btn.closest('.feedback-buttons');
        const messageId = container.getAttribute('data-message-id');
        
        submitFeedback(messageId, feedbackType, container);
    }
});

function submitFeedback(messageId, feedbackType, container) {
    const url = `{% url "ai_assistant:message_feedback" 0 %}`.replace('0', messageId);
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            feedback: feedbackType
        })
    })
    .then(response => {
        if (!response.ok) throw new Error('Network response was not ok');
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Disable all buttons and highlight selected
            container.querySelectorAll('.feedback-btn').forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('btn-outline-success', 'btn-outline-danger');
                
                if (btn.getAttribute('data-feedback') === feedbackType) {
                    btn.classList.add(feedbackType === 'positive' ? 'btn-success' : 'btn-danger');
                } else {
                    btn.classList.add('btn-secondary');
                }
            });
        }
    })
    .catch(error => {
        console.error('Feedback submission error:', error);
        alert('Geri bildirim gönderilemedi');
    });
}
</script>
{% endblock %}
