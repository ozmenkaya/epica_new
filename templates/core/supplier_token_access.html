{% extends "base.html" %}
{% load i18n %}
{% load form_tags %}

{% block title %}Talep #{{ ticket.id }} - {{ ticket.title }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h5 class="mb-0">{{ ticket.title }}</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <small class="text-muted d-block">{% trans "Organizasyon" %}</small>
              <strong>{{ organization.name }}</strong>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Kategori</small>
              <strong>{{ ticket.category.name }}</strong>
            </div>
            {% if ticket.desired_quantity %}
            <div class="col-md-6">
              <small class="text-muted d-block">Miktar</small>
              <strong>{{ ticket.desired_quantity }}</strong>
            </div>
            {% endif %}
            <div class="col-md-6">
              <small class="text-muted d-block">Durum</small>
              <span class="badge bg-secondary">{{ ticket.get_status_display }}</span>
            </div>
          </div>

          {% if ticket.description %}
          <div class="mt-3">
            <small class="text-muted d-block">Açıklama</small>
            <div class="bg-light p-2 rounded small">
              {{ ticket.description|linebreaksbr }}
            </div>
          </div>
          {% endif %}

          {% if extra_fields %}
          <div class="mt-3">
            <small class="text-muted d-block mb-2">{% trans "Form Yanıtları" %}</small>
            <div class="bg-light p-2 rounded small">
              {% for field in extra_fields %}
                <div class="mb-1"><span class="text-muted">{{ field.label }}:</span> <strong>{{ field.value }}</strong></div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          {% if ticket.attachments.all %}
          <div class="mt-3">
            <small class="text-muted d-block mb-2">Ekler</small>
            {% for att in ticket.attachments.all %}
              <div class="small">
                <a href="{{ att.file.url }}" target="_blank" class="text-decoration-none">
                  <i class="bi bi-file-earmark"></i> {{ att.file.name|slice:"-60:" }}
                </a>
              </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>

      {% if existing_quote %}
      <div class="alert alert-success">
        <h5><i class="bi bi-check-circle"></i> Teklifiniz Alındı</h5>
        <p class="mb-1"><strong>Birim Fiyat:</strong> {{ existing_unit_price|default:existing_quote.amount }} {{ existing_quote.currency }}</p>
        <p class="mb-1"><strong>Toplam:</strong> {{ existing_quote.amount }} {{ existing_quote.currency }} ({{ ticket.desired_quantity }} adet)</p>
        {% if existing_quote.note %}
        <p class="mb-0"><strong>Not:</strong> {{ existing_quote.note }}</p>
        {% endif %}
        <hr>
        <p class="mb-0 small">Teklifinizi güncellemek için aşağıdaki formu kullanabilirsiniz.</p>
      </div>
      {% endif %}

      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            {% if supplier_email and supplier %}
              {{ supplier.name }}, lütfen teklif verin
            {% else %}
              <i class="bi bi-currency-dollar"></i> Teklif Verin
            {% endif %}
          </h5>
        </div>
        <div class="card-body">
          
          <form method="post">
            {% csrf_token %}
            
            {% if supplier_email and supplier %}
              {# Hidden fields for auto-filled supplier info #}
              <input type="hidden" name="supplier_email" value="{{ supplier_email }}">
              <input type="hidden" name="supplier_name" value="{{ supplier.name }}">
            {% else %}
              {# Manual entry for suppliers not in system #}
              <div class="mb-3">
                <label for="supplier_email" class="form-label">E-posta <span class="text-danger">*</span></label>
                <input type="email" class="form-control" id="supplier_email" name="supplier_email" 
                       value="{{ supplier_email }}" required>
              </div>

              <div class="mb-3">
                <label for="supplier_name" class="form-label">Firma Adı <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="supplier_name" name="supplier_name" 
                       value="{% if supplier %}{{ supplier.name }}{% endif %}" required>
              </div>
            {% endif %}

            <div class="mb-3">
              <label for="amount" class="form-label">Birim Fiyat <span class="text-danger">*</span></label>
              <div class="input-group">
                <input type="number" step="0.000001" min="0" class="form-control" id="amount" name="amount" 
                       value="{% if existing_unit_price %}{{ existing_unit_price }}{% endif %}" required>
                <select class="form-select" name="currency" style="max-width: 120px;">
                  <option value="TRY" {% if not existing_quote or existing_quote.currency == 'TRY' %}selected{% endif %}>TRY</option>
                  <option value="USD" {% if existing_quote and existing_quote.currency == 'USD' %}selected{% endif %}>USD</option>
                  <option value="EUR" {% if existing_quote and existing_quote.currency == 'EUR' %}selected{% endif %}>EUR</option>
                  <option value="GBP" {% if existing_quote and existing_quote.currency == 'GBP' %}selected{% endif %}>GBP</option>
                </select>
              </div>
              {% if ticket.desired_quantity %}
              <small class="text-muted">Toplam: <span id="total-amount">{% if existing_unit_price %}{{ existing_unit_price }}{% else %}0{% endif %}</span> × {{ ticket.desired_quantity }} adet</small>
              {% endif %}
            </div>

            <script>
              // Calculate total when unit price changes
              document.getElementById('amount').addEventListener('input', function() {
                const unitPrice = parseFloat(this.value) || 0;
                const quantity = {{ ticket.desired_quantity|default:1 }};
                const total = (unitPrice * quantity).toFixed(2);
                const totalEl = document.getElementById('total-amount');
                if (totalEl) {
                  totalEl.textContent = unitPrice.toFixed(6);
                }
              });
              
              // Initialize total on page load
              {% if existing_unit_price %}
              document.addEventListener('DOMContentLoaded', function() {
                const unitPrice = {{ existing_unit_price }};
                const totalEl = document.getElementById('total-amount');
                if (totalEl) {
                  totalEl.textContent = unitPrice.toFixed(6);
                }
              });
              {% endif %}
            </script>

            <div class="mb-3">
              <label for="note" class="form-label">Not / Açıklama (İsteğe Bağlı)</label>
              <textarea class="form-control" id="note" name="note" rows="4" 
                        placeholder="Teslimat süresi, özel notlar, vb...">{% if existing_quote %}{{ existing_quote.note }}{% endif %}</textarea>
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-success btn-lg">
                <i class="bi bi-send"></i> {% if existing_quote %}Teklifi Güncelle{% else %}Teklif Gönder{% endif %}
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="mt-4 text-center text-muted">
        <small>
          <i class="bi bi-shield-check"></i> Bu sayfa güvenli bir bağlantıdır ve size özeldir. 
          Giriş yapmanıza gerek yoktur.
        </small>
      </div>

    </div>
  </div>
</div>
{% endblock %}
