{% extends "base.html" %}
{% load i18n %}
{% load custom_filters %}

{% block content %}
<div class="container-fluid">
	<div class="row mb-4">
		<div class="col-12">
			<div class="d-flex justify-content-between align-items-center">
				<div>
					<h2 class="mb-0">
						<i class="bi bi-speedometer2"></i> {% trans "Dashboard" %}
					</h2>
					{% if org %}
					<p class="text-muted mb-0">{{ org.name }}</p>
					{% endif %}
				</div>
				<a href="{% url 'dashboard_widgets_settings' %}" class="btn btn-outline-primary">
					<i class="bi bi-gear"></i> {% trans "Widget AyarlarÄ±" %}
				</a>
			</div>
		</div>
	</div>

	{% if org %}
	<!-- Dynamic Widgets -->
	<div class="row">
		{% for widget in widgets %}
			{% if widget.widget_type == 'daily_orders' %}
			<div class="col-md-3 mb-3">
				<div class="card shadow-sm h-100">
					<div class="card-body text-center">
						<i class="bi bi-calendar-day text-primary" style="font-size: 2.5rem;"></i>
						<h3 class="mt-3 mb-0">{{ widget_data.daily_orders.count }}</h3>
						<p class="text-muted mb-0">{% trans "GÃ¼nlÃ¼k SipariÅŸler" %}</p>
					</div>
				</div>
			</div>
			
			{% elif widget.widget_type == 'weekly_orders' %}
			<div class="col-md-3 mb-3">
				<div class="card shadow-sm h-100">
					<div class="card-body text-center">
						<i class="bi bi-calendar-week text-success" style="font-size: 2.5rem;"></i>
						<h3 class="mt-3 mb-0">{{ widget_data.weekly_orders.count }}</h3>
						<p class="text-muted mb-0">{% trans "HaftalÄ±k SipariÅŸler" %}</p>
					</div>
				</div>
			</div>
			
			{% elif widget.widget_type == 'delayed_orders' %}
			<div class="col-md-3 mb-3">
				<div class="card shadow-sm h-100">
					<div class="card-body">
						<div class="text-center">
							<i class="bi bi-exclamation-triangle text-danger" style="font-size: 2.5rem;"></i>
							<h3 class="mt-3 mb-0">{{ widget_data.delayed_orders.count }}</h3>
							<p class="text-muted mb-0">{% trans "Geciken SipariÅŸler" %}</p>
						</div>
						{% if widget_data.delayed_orders.orders %}
						<div class="mt-3 text-start small">
							{% for order in widget_data.delayed_orders.orders %}
							<div class="mb-1">
								<a href="{% url 'order_detail' order.id %}" class="text-decoration-none text-danger">
									#{{ order.id }} - {{ order.supplier.name|truncatewords:3 }}
								</a>
							</div>
							{% endfor %}
						</div>
						{% endif %}
					</div>
				</div>
			</div>
			
			{% elif widget.widget_type == 'month_comparison' %}
			<div class="col-md-6 mb-3">
				<div class="card shadow-sm h-100">
					<div class="card-header bg-primary text-white">
						<h5 class="mb-0"><i class="bi bi-graph-up"></i> {% trans "AylÄ±k KarÅŸÄ±laÅŸtÄ±rma" %}</h5>
					</div>
					<div class="card-body">
						<div class="row text-center">
							<div class="col-6">
								<h4>{{ widget_data.month_comparison.last_month }}</h4>
								<p class="text-muted">{% trans "GeÃ§en Ay" %}</p>
							</div>
							<div class="col-6">
								<h4>{{ widget_data.month_comparison.this_month }}</h4>
								<p class="text-muted">{% trans "Bu Ay" %}</p>
							</div>
						</div>
						<div class="text-center mt-3">
							{% if widget_data.month_comparison.change_percent > 0 %}
							<span class="badge bg-success" style="font-size: 1.2rem;">
								<i class="bi bi-arrow-up"></i> +{{ widget_data.month_comparison.change_percent }}%
							</span>
							{% elif widget_data.month_comparison.change_percent < 0 %}
							<span class="badge bg-danger" style="font-size: 1.2rem;">
								<i class="bi bi-arrow-down"></i> {{ widget_data.month_comparison.change_percent }}%
							</span>
							{% else %}
							<span class="badge bg-secondary" style="font-size: 1.2rem;">
								{{ widget_data.month_comparison.change_percent }}%
							</span>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
			
			{% elif widget.widget_type == 'top_suppliers' %}
			<div class="col-12 mb-3">
				<div class="card shadow-sm">
					<div class="card-header bg-success text-white">
						<h5 class="mb-0">
							<i class="bi bi-trophy-fill"></i> {% trans "En Ä°yi Performans GÃ¶steren TedarikÃ§iler" %}
						</h5>
					</div>
					<div class="card-body p-0">
						{% if widget_data.top_suppliers.suppliers %}
						<div class="table-responsive">
							<table class="table table-hover mb-0">
								<thead class="table-light">
									<tr>
										<th class="text-center" style="width: 60px;">#</th>
										<th>{% trans "TedarikÃ§i" %}</th>
										<th class="text-center">{% trans "Genel Skor" %}</th>
										<th class="text-center">{% trans "Kazanma OranÄ±" %}</th>
										<th class="text-center">{% trans "ZamanÄ±nda Teslimat" %}</th>
										<th class="text-center">{% trans "MÃ¼ÅŸteri Memnuniyeti" %}</th>
										<th></th>
									</tr>
								</thead>
								<tbody>
								{% for metrics in widget_data.top_suppliers.suppliers %}
									<tr>
										<td class="text-center fw-bold">
											{% if forloop.counter == 1 %}ğŸ¥‡
											{% elif forloop.counter == 2 %}ğŸ¥ˆ
											{% elif forloop.counter == 3 %}ğŸ¥‰
											{% else %}{{ forloop.counter }}{% endif %}
										</td>
										<td class="fw-medium">{{ metrics.supplier.name }}</td>
										<td class="text-center">
											<span class="badge 
												{% if metrics.overall_score >= 90 %}bg-success
												{% elif metrics.overall_score >= 75 %}bg-info
												{% elif metrics.overall_score >= 60 %}bg-warning
												{% else %}bg-secondary{% endif %}" 
												style="font-size: 1.1rem; min-width: 60px;">
												{{ metrics.overall_score|floatformat:1 }}
											</span>
										</td>
										<td class="text-center">%{{ metrics.win_rate_percent|floatformat:0 }}</td>
										<td class="text-center">%{{ metrics.on_time_delivery_percent|floatformat:0 }}</td>
										<td class="text-center">{{ metrics.avg_overall_satisfaction|floatformat:1 }}/5 â­</td>
										<td class="text-end">
											<a href="{% url 'supplier_detail' metrics.supplier.id %}" class="btn btn-sm btn-outline-primary">
												{% trans "Detay" %}
											</a>
										</td>
									</tr>
								{% endfor %}
								</tbody>
							</table>
						</div>
						{% else %}
						<div class="p-4 text-center text-muted">
							{% trans "HenÃ¼z tedarikÃ§i performans verisi yok." %}
						</div>
						{% endif %}
					</div>
				</div>
			</div>
			
			{% elif widget.widget_type == 'recent_feedback' %}
			<div class="col-12 mb-3">
				<div class="card shadow-sm">
					<div class="card-header bg-info text-white">
						<h5 class="mb-0">
							<i class="bi bi-star-fill"></i> {% trans "Son MÃ¼ÅŸteri DeÄŸerlendirmeleri" %}
						</h5>
					</div>
					<div class="card-body">
						{% if widget_data.recent_feedback.feedback %}
						{% for feedback in widget_data.recent_feedback.feedback %}
						<div class="mb-3 pb-3 {% if not forloop.last %}border-bottom{% endif %}">
							<div class="row align-items-center">
								<div class="col-md-3">
									<strong>{{ feedback.order.supplier.name }}</strong><br>
									<small class="text-muted">{{ feedback.order.ticket.customer.name }}</small>
								</div>
								<div class="col-md-2 text-center">
									<div class="small text-muted">{% trans "ÃœrÃ¼n" %}</div>
									<div>
										{% for i in "12345" %}
											{% if forloop.counter <= feedback.product_quality %}â­{% else %}â˜†{% endif %}
										{% endfor %}
									</div>
								</div>
								<div class="col-md-2 text-center">
									<div class="small text-muted">{% trans "Ä°letiÅŸim" %}</div>
									<div>
										{% for i in "12345" %}
											{% if forloop.counter <= feedback.communication %}â­{% else %}â˜†{% endif %}
										{% endfor %}
									</div>
								</div>
								<div class="col-md-2 text-center">
									<div class="small text-muted">{% trans "Teslimat" %}</div>
									<div>
										{% for i in "12345" %}
											{% if forloop.counter <= feedback.delivery_time %}â­{% else %}â˜†{% endif %}
										{% endfor %}
									</div>
								</div>
								<div class="col-md-2 text-center">
									<div class="small text-muted">{% trans "Genel" %}</div>
									<div>
										{% for i in "12345" %}
											{% if forloop.counter <= feedback.overall_satisfaction %}â­{% else %}â˜†{% endif %}
										{% endfor %}
									</div>
								</div>
								<div class="col-md-1 text-end">
									<small class="text-muted">{{ feedback.created_at|date:"d.m.Y" }}</small>
								</div>
							</div>
							{% if feedback.comment %}
							<div class="mt-2">
								<small class="text-muted"><em>"{{ feedback.comment|truncatewords:20 }}"</em></small>
							</div>
							{% endif %}
						</div>
						{% endfor %}
						{% else %}
						<div class="p-4 text-center text-muted">
							{% trans "HenÃ¼z deÄŸerlendirme yok." %}
						</div>
						{% endif %}
					</div>
				</div>
			</div>
			{% endif %}
		{% endfor %}
	</div>
	<!-- HÄ±zlÄ± EriÅŸim (Always visible) -->
	<div class="row mt-4">
		<div class="col-12">
			<h4 class="mb-3">{% trans "HÄ±zlÄ± EriÅŸim" %}</h4>
		</div>
		<div class="col-md-3 mb-3">
			<a href="{% url 'customers_list' %}" class="text-decoration-none">
				<div class="card shadow-sm h-100 text-center">
					<div class="card-body">
						<i class="bi bi-people-fill text-primary" style="font-size: 2.5rem;"></i>
						<h5 class="mt-3">{% trans "MÃ¼ÅŸteriler" %}</h5>
					</div>
				</div>
			</a>
		</div>
		<div class="col-md-3 mb-3">
			<a href="{% url 'suppliers_list' %}" class="text-decoration-none">
				<div class="card shadow-sm h-100 text-center">
					<div class="card-body">
						<i class="bi bi-building text-success" style="font-size: 2.5rem;"></i>
						<h5 class="mt-3">{% trans "TedarikÃ§iler" %}</h5>
					</div>
				</div>
			</a>
		</div>
		<div class="col-md-3 mb-3">
			<a href="{% url 'tickets_list' %}" class="text-decoration-none">
				<div class="card shadow-sm h-100 text-center">
					<div class="card-body">
						<i class="bi bi-ticket-detailed text-warning" style="font-size: 2.5rem;"></i>
						<h5 class="mt-3">{% trans "Talepler" %}</h5>
					</div>
				</div>
			</a>
		</div>
		<div class="col-md-3 mb-3">
			<a href="{% url 'orders_list' %}" class="text-decoration-none">
				<div class="card shadow-sm h-100 text-center">
					<div class="card-body">
						<i class="bi bi-box-seam text-info" style="font-size: 2.5rem;"></i>
						<h5 class="mt-3">{% trans "SipariÅŸler" %}</h5>
					</div>
				</div>
			</a>
		</div>
	</div>

	{% else %}
	<div class="alert alert-warning">
		{% trans "HiÃ§ organizasyon seÃ§ili deÄŸil." %} <a href="{% url 'org_list' %}">{% trans "SeÃ§" %}</a>
	</div>
	{% endif %}
</div>
{% endblock %}
