{% extends "base.html" %}
{% load i18n %}
{% load form_tags %}
{% block title %}{% trans "Talep" %} #{{ ticket.id }} - {% trans "Teklifler" %}{% endblock %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-4 col-xl-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title mb-2">{% trans "Talep" %} #{{ ticket.id }} - {{ ticket.title }}</h5>
        <div class="row g-2 text-muted">
          <div class="col-12 col-md-auto"><strong>{% trans "Kategori" %}:</strong> {{ ticket.category.name }}</div>
          <div class="col-12 col-md-auto"><strong>{% trans "Müşteri" %}:</strong> {{ ticket.customer.name }}</div>
          <div class="col-12 col-md-auto"><strong>{% trans "Durum" %}:</strong> {{ ticket.get_status_display }}</div>
          {% if ticket.desired_quantity %}
          <div class="col-12 col-md-auto"><strong>{% trans "Adet" %}:</strong> {{ ticket.desired_quantity }}</div>
          {% endif %}
        </div>
        {% if ticket.description %}
        <div class="mt-2">
          <strong>{% trans "Açıklama" %}:</strong>
          <div class="text-muted">{{ ticket.description|linebreaksbr }}</div>
        </div>
        {% endif %}
        {% if extra_fields %}
        <div class="mt-2">
          <strong>{% trans "Form Yanıtları" %}:</strong>
          <ul class="mb-0">
            {% for f in extra_fields %}
              <li><span class="text-muted">{{ f.label }}:</span> {{ f.value }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header"><strong>{% trans "Tedarikçi Teklifleri" %}</strong></div>
      <div class="card-body">
        <ul class="mb-0">
          {% for q in quotes %}
            <li>
              <strong>{{ q.supplier.name }}</strong> → {{ q.amount }} {{ q.currency }} {% if ticket.selected_quote_id == q.id %}<em class="text-success">({% trans "seçili" %})</em>{% endif %}
              {% if q.note %}<div><small class="text-muted">{{ q.note|linebreaksbr }}</small></div>{% endif %}
              {% if q.items.all %}
                <div class="mt-1">
                  <small class="text-muted">{% trans "Kalemler" %}:</small>
                  <ul>
                    {% for it in q.items.all %}
                      <li>{{ it.description }} — {{ it.quantity }} x {{ it.unit_price|remove_trailing_zeros }} = {{ it.line_total|remove_trailing_zeros }} {{ q.currency }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </li>
          {% empty %}
            <li class="text-muted">{% trans "Henüz teklif yok." %}</li>
          {% endfor %}
        </ul>
        
        {% if suppliers_without_quotes %}
        <div class="mt-3 pt-3 border-top">
          <small class="text-muted d-block mb-2"><strong>{% trans "Teklif Beklenenler" %}:</strong></small>
          <ul class="mb-0 small">
            {% for supplier in suppliers_without_quotes %}
              <li class="text-warning">{{ supplier.name }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header"><strong>{% trans "Müşteri Yorumları" %}</strong></div>
      <div class="card-body">
        {% if comments %}
          <ul class="list-unstyled mb-0">
            {% for c in comments %}
              <li class="mb-2">
                <div>
                  <small class="text-muted">{{ c.created_at|date:"Y-m-d H:i" }} — {% if c.author_customer %}{{ c.author_customer.name }}{% else %}{% trans "Anonim" %}{% endif %}{% if c.quote %} ({% trans "Teklif" %} #{{ c.quote.id }}){% endif %}</small>
                </div>
                <div>{{ c.text|linebreaksbr }}</div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">{% trans "Yorum yok." %}</div>
        {% endif %}
      </div>
      <div class="card-footer">
        <a class="btn btn-sm btn-outline-secondary" href="{% url 'offers_list' %}">{% trans "Teklifli Taleplere Dön" %}</a>
      </div>
  </div>

    {% if ticket.email_replies.all %}
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-info text-white"><strong><i class="bi bi-envelope"></i> {% trans "Tedarikçi Email Yanıtları" %}</strong></div>
      <div class="card-body">
        <ul class="list-unstyled mb-0">
          {% for reply in ticket.email_replies.all %}
            <li class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <strong>{% if reply.supplier %}{{ reply.supplier.name }}{% else %}{{ reply.from_email }}{% endif %}</strong>
                  <br>
                  <small class="text-muted">{{ reply.received_at|date:"Y-m-d H:i" }}</small>
                </div>
              </div>
              {% if reply.subject %}
              <div class="mb-1"><strong>Konu:</strong> {{ reply.subject }}</div>
              {% endif %}
              <div class="bg-light p-2 rounded">{{ reply.body|linebreaksbr }}</div>
            </li>
          {% endfor %}
        </ul>
      </div>
    </div>
    {% endif %}

  </div> <!-- /left column -->
  <div class="col-lg-8 col-xl-8">
    <div class="card shadow-sm position-sticky" style="top:1rem;">
      <div class="card-header"><strong>{% trans "Müşteriye Sunulacak Fiyat" %}</strong></div>
      <div class="card-body">
        <form method="post" novalidate>
          {% csrf_token %}
          {% bootstrap_field form.selected_quote %}
          <div id="analysis-box" class="alert alert-info py-2 small" style="display:none"></div>
          <div class="border rounded p-2 mb-3">
            <h6>{% trans "Kalem Bazlı Yüzde Kar" %}</h6>
            <div class="table-responsive">
              <table class="table table-sm align-middle mb-0" id="items-table">
                <thead>
                  <tr>
                    <th style="width:40px" class="text-center">
                      <input type="checkbox" id="select-all-items" class="form-check-input" title="Tümünü Seç/Kaldır">
                    </th>
                    <th>{% trans "Açıklama" %}</th>
                    <th class="text-end">{% trans "Birim Alış" %}</th>
                    <th class="text-end">{% trans "Adet" %}</th>
                    <th class="text-end">{% trans "Toplam Alış" %}</th>
                    <th style="width:110px" class="text-end">% {% trans "Kar" %}</th>
                    <th class="text-end" id="markup-header">{% trans "Kar" %} (<span id="currency-symbol">₺</span>)</th>
                    <th class="text-end">{% trans "Birim Satış" %}</th>
                    <th class="text-end">{% trans "Toplam Satış" %}</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr class="fw-bold">
                    <td class="text-end" colspan="8">{% trans "Toplam Satış" %}</td>
                    <td class="text-end" id="grand-total">0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          {% bootstrap_field form.offered_note %}
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">{% trans "Teklifi Seç ve Kaydet" %}</button>
            <a class="btn btn-outline-secondary" href="{% url 'tickets_list' %}">{% trans "Geri" %}</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{{ quotes_data|json_script:"quotes-data" }}
{{ analysis_base|json_script:"analysis-base" }}
<script>
  (function(){
    function getCurrencySymbol(currency){
      const symbols = {
        'TRY': '₺',
        'USD': '$',
        'EUR': '€',
        'GBP': '£'
      };
      return symbols[currency] || currency;
    }
    
    function formatNumber(value) {
      // Remove trailing zeros and unnecessary decimal point
      const num = parseFloat(value) || 0;
      // Convert to string with up to 6 decimals, then remove trailing zeros
      return num.toFixed(6).replace(/\.?0+$/, '');
    }
    
    function loadQuoteItems(quoteId){
      const data = JSON.parse(document.getElementById('quotes-data').textContent);
      const q = data.find(x=> String(x.id) === String(quoteId));
      if(!q){ return; }
      
      // Update currency symbol in header
      const currencySymbolEl = document.getElementById('currency-symbol');
      if(currencySymbolEl){
        currencySymbolEl.textContent = getCurrencySymbol(q.currency);
      }
      
      // Build tbody
      const tbody = document.querySelector('#items-table tbody');
      if(!tbody){ return; }
      tbody.innerHTML = '';
      q.items.forEach(it => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-line-total', it.line_total);
        tr.setAttribute('data-item-id', it.id);
        const isChecked = it.is_selected !== false; // Default to true if not set
        
        // Calculate initial markup amount from percentage if available
        let initialMarkupAmt = '';
        if(it.prefill_pct && it.line_total){
          initialMarkupAmt = ((parseFloat(it.line_total) * parseFloat(it.prefill_pct)) / 100).toFixed(2);
        }
        
        tr.setAttribute('data-quantity', it.quantity);
        tr.setAttribute('data-unit-price', it.unit_price);
        
        // Format unit price and line total - remove trailing zeros
        const formattedUnitPrice = formatNumber(it.unit_price);
        const formattedLineTotal = formatNumber(it.line_total);
        
        tr.innerHTML = `
          <td class="text-center">
            <input type="checkbox" name="item_selected_${it.id}" class="form-check-input item-checkbox" ${isChecked ? 'checked' : ''}>
          </td>
          <td>${it.description}</td>
          <td class="text-end unit-purchase-price">${formattedUnitPrice}</td>
          <td class="text-end quantity">${it.quantity}</td>
          <td class="text-end total-purchase">${formattedLineTotal}</td>
          <td class="text-end"><input type="number" step="0.01" min="0" name="markup_pct_${it.id}" value="${it.prefill_pct || ''}" class="form-control form-control-sm text-end markup-pct-input" placeholder="%" data-item-id="${it.id}" /></td>
          <td class="text-end"><input type="number" step="0.01" min="0" name="markup_amt_${it.id}" value="${initialMarkupAmt}" class="form-control form-control-sm text-end markup-amt-input" placeholder="0.00" data-item-id="${it.id}" /></td>
          <td class="text-end unit-sell-price">0.00</td>
          <td class="text-end total-sell">0.00</td>`;
        tbody.appendChild(tr);
      });
      recalc();
      renderAnalysis(q);
    }
    function renderAnalysis(selected){
      const el = document.getElementById('analysis-box');
      if(!el) return;
      const base = JSON.parse(document.getElementById('analysis-base').textContent || '""');
      let extra = '';
      if(selected && selected.items && selected.items.length){
        const avgUnit = selected.items.reduce((s,it)=> s + (parseFloat(it.line_total)||0),0) / selected.items.length;
        extra = ` {% trans "Seçilen tedarikçi" %}: ${selected.supplier}. {% trans "Ortalama kalem tutarı" %}: ${avgUnit.toFixed(2)}.`;
      }
      const text = (base + extra).trim();
      if(text){ el.style.display='block'; el.textContent = text; } else { el.style.display='none'; }
    }
    function fmt(v){
      try { return (parseFloat(v)||0).toFixed(2); } catch(e){ return '0.00'; }
    }
    function recalc(){
      var grand = 0.0;
      document.querySelectorAll('#items-table tbody tr').forEach(function(tr){
        var checkbox = tr.querySelector('.item-checkbox');
        var isSelected = checkbox && checkbox.checked;
        var base = parseFloat(tr.getAttribute('data-line-total')) || 0;
        var quantity = parseFloat(tr.getAttribute('data-quantity')) || 1;
        var unitPrice = parseFloat(tr.getAttribute('data-unit-price')) || 0;
        var pctInput = tr.querySelector('.markup-pct-input');
        var amtInput = tr.querySelector('.markup-amt-input');
        var pct = parseFloat(pctInput && pctInput.value) || 0;
        var abs = parseFloat(amtInput && amtInput.value) || 0;
        
        // If we have a percentage, recalculate amount (unless amount was just manually changed)
        if(pct && !tr.dataset.amtManual){
          abs = base * pct / 100.0;
          if(amtInput) amtInput.value = fmt(abs);
        }
        
        var totalSell = base + abs;
        var unitSell = quantity > 0 ? totalSell / quantity : 0;
        
        tr.querySelector('.total-sell').textContent = fmt(totalSell);
        tr.querySelector('.unit-sell-price').textContent = fmt(unitSell);
        
        // Only add to grand total if selected
        if(isSelected){
          grand += totalSell;
        }
        
        // Visual feedback for unselected rows
        if(!isSelected){
          tr.style.opacity = '0.5';
          tr.style.textDecoration = 'line-through';
        } else {
          tr.style.opacity = '1';
          tr.style.textDecoration = 'none';
        }
      });
      var g = document.getElementById('grand-total'); if(g) g.textContent = fmt(grand);
    }
    
    // Handle select all checkbox
    document.addEventListener('change', function(e){
      if(e.target.id === 'select-all-items'){
        const checked = e.target.checked;
        document.querySelectorAll('.item-checkbox').forEach(function(cb){
          cb.checked = checked;
        });
        recalc();
      } else if(e.target.classList.contains('item-checkbox')){
        recalc();
      }
    });
    
    document.addEventListener('input', function(e){ 
      if(e.target.classList.contains('markup-pct-input')){
        // When percentage changes, update amount
        var tr = e.target.closest('tr');
        if(tr){
          var base = parseFloat(tr.getAttribute('data-line-total')) || 0;
          var pct = parseFloat(e.target.value) || 0;
          var abs = base * pct / 100.0;
          var amtInput = tr.querySelector('.markup-amt-input');
          if(amtInput){
            amtInput.value = fmt(abs);
          }
          delete tr.dataset.amtManual;
        }
        recalc();
      } else if(e.target.classList.contains('markup-amt-input')){
        // When amount changes, update percentage
        var tr = e.target.closest('tr');
        if(tr){
          var base = parseFloat(tr.getAttribute('data-line-total')) || 0;
          var abs = parseFloat(e.target.value) || 0;
          if(base > 0){
            var pct = (abs / base) * 100.0;
            var pctInput = tr.querySelector('.markup-pct-input');
            if(pctInput){
              pctInput.value = fmt(pct);
            }
          }
          tr.dataset.amtManual = 'true';
        }
        recalc();
      }
    });
    
    document.addEventListener('DOMContentLoaded', function(){
      // If quote select exists, hook change
      var select = document.getElementById('id_selected_quote');
      if(select){
        select.addEventListener('change', function(){ loadQuoteItems(this.value); });
        // initial
        if(select.value){ loadQuoteItems(select.value); }
      }
      recalc();
    });
  })();
 </script>
{% endblock %}
