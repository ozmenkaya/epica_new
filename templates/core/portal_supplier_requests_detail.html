{% extends "base.html" %}
{% load i18n %}
{% load form_tags %}
{% block content %}
<div class="row g-3">
  <!-- Left: Talep Bilgileri -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5 class="card-title mb-2">{{ ticket.title }}</h5>
        <div class="text-muted small">
          <span class="me-3"><strong>{% trans "Kategori" %}:</strong> {{ ticket.category.name }}</span>
          <span class="me-3"><strong>{% trans "Durum" %}:</strong> {{ ticket.get_status_display }}</span>
          <span><strong>{% trans "Oluşturuldu" %}:</strong> {{ ticket.created_at|date:"Y-m-d H:i" }}</span>
        </div>
        <hr>
        <p class="mb-1"><strong>{% trans "Adet" %}:</strong> {{ ticket.desired_quantity }}</p>
        <p class="mb-0"><strong>{% trans "Açıklama" %}:</strong></p>
        <p>{{ ticket.description|linebreaksbr }}</p>
        {% if extra_fields %}
        <div class="mt-2">
          <strong>{% trans "Form Yanıtları" %}:</strong>
          <ul class="mb-0">
            {% for f in extra_fields %}
              <li><span class="text-muted">{{ f.label }}:</span> {{ f.value }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header"><strong>{% trans "Ekler" %}</strong></div>
      <div class="card-body">
        <ul class="mb-0">
          {% for a in ticket.attachments.all %}
            <li><a href="{{ a.file.url }}" target="_blank">{{ a.file.name|slice:"-60:" }}</a> <small class="text-muted">({{ a.uploaded_at|date:"Y-m-d H:i" }})</small></li>
          {% empty %}
            <li class="text-muted">{% trans "Dosya yok." %}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Right: Teklifim -->
  <div class="col-12 col-md-8">
    <div class="card shadow-sm sticky-top" style="top: 1rem;">
      <div class="card-header"><strong>{% trans "Teklifim" %}</strong></div>
      <div class="card-body">
        {% if existing %}
          <div class="alert alert-info py-2">{% trans "Mevcut teklifiniz" %}: <strong>{{ existing.amount }} {{ existing.currency }}</strong> <small class="text-muted">— {{ existing.created_at|date:"Y-m-d H:i" }}</small><br>{% if existing.note %}<em>{{ existing.note|linebreaksbr }}</em>{% endif %}</div>
        {% endif %}
        <form method="post" novalidate>
          {% csrf_token %}
          <h6 class="mb-2">{% trans "Ürün/Hizmet Kalemleri" %}</h6>
          <div class="d-flex justify-content-between align-items-center mb-2">
            {% if not is_simplified %}
            <div class="small text-muted">{% trans "Ürününüz listede yok mu?" %} <a href="{% url 'supplier_products_new' %}" target="_blank">{% trans "Yeni Ürün oluştur" %}</a></div>
            {% else %}
            <div class="small text-muted">{% trans "Basit usul tedarikçi - Sadece birim fiyat, adet ve açıklama giriniz" %}</div>
            {% endif %}
            <button id="add-item" class="btn btn-sm btn-outline-primary" type="button">{% trans "Kalem Ekle" %}</button>
          </div>
          <div class="border rounded p-2 mb-3" id="items-container">
            {{ items_formset.management_form }}
            {% for f in items_formset %}
              <div class="row g-2 align-items-end mb-2 item-row">
                {% if not is_simplified %}
                <div class="col-12 col-md-3">{% bootstrap_field f.product %}</div>
                <div class="col-12 col-md-4">{% bootstrap_field f.description %}</div>
                {% else %}
                <div class="col-12 col-md-5">{% bootstrap_field f.description %}</div>
                {% endif %}
                <div class="col-6 col-md-2">{% bootstrap_field f.quantity %}</div>
                <div class="col-6 col-md-2">{% bootstrap_field f.unit_price %}</div>
                <div class="col-12 col-md-1">{% if f.DELETE %}{% bootstrap_field f.DELETE %}{% endif %}</div>
              </div>
            {% endfor %}
            <template id="empty-form-template">
              <div class="row g-2 align-items-end mb-2 item-row">
                {% if not is_simplified %}
                <div class="col-12 col-md-3">{% bootstrap_field items_formset.empty_form.product %}</div>
                <div class="col-12 col-md-4">{% bootstrap_field items_formset.empty_form.description %}</div>
                {% else %}
                <div class="col-12 col-md-5">{% bootstrap_field items_formset.empty_form.description %}</div>
                {% endif %}
                <div class="col-6 col-md-2">{% bootstrap_field items_formset.empty_form.quantity %}</div>
                <div class="col-6 col-md-2">{% bootstrap_field items_formset.empty_form.unit_price %}</div>
                <div class="col-12 col-md-1">{% if items_formset.empty_form.DELETE %}{% bootstrap_field items_formset.empty_form.DELETE %}{% endif %}</div>
              </div>
            </template>
          </div>
          <h6 class="mb-2">{% trans "Para Birimi ve Açıklama" %}</h6>
          {% bootstrap_field note_form.currency %}
          {% for field in note_form %}
            {% if field.name != 'currency' %}{% bootstrap_field field %}{% endif %}
          {% endfor %}
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">{% trans "Teklif Gönder" %}</button>
            <a class="btn btn-outline-secondary" href="{% url 'supplier_requests_list' %}">{% trans "Taleplere dön" %}</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  (function(){
    const container = document.getElementById('items-container');
    const addBtn = document.getElementById('add-item');
    const totalForms = container.querySelector('input[name$="-TOTAL_FORMS"]');
    const template = document.getElementById('empty-form-template');

    function addRow() {
      const idx = parseInt(totalForms.value, 10);
      const tpl = document.createElement('div');
      tpl.innerHTML = template.innerHTML.trim();
      // update __prefix__ to index
      tpl.innerHTML = tpl.innerHTML.replaceAll('__prefix__', String(idx));
      // add a simple remove button if no DELETE checkbox is present
      const row = tpl.firstElementChild;
      const delCol = row.querySelector('.col-12.col-md-1');
      if (delCol && !delCol.querySelector('input[type="checkbox"]')) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-outline-danger';
        btn.textContent = '{% trans "Sil" %}';
        btn.addEventListener('click', () => row.remove());
        delCol.appendChild(btn);
      }
      container.appendChild(row);
      totalForms.value = String(idx + 1);
    }

    if (addBtn) addBtn.addEventListener('click', addRow);
  })();
</script>
{% endblock %}
