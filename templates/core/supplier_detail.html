{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="container-fluid">
	<!-- Tedarikçi Başlık -->
	<div class="card shadow-sm mb-4">
		<div class="card-header d-flex justify-content-between align-items-center">
			<h4 class="mb-0">
				<i class="bi bi-building"></i> {{ supplier.name }}
			</h4>
			<div>
				{% if 'suppliers_edit' in tenant_permissions %}
					<button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#reviewModal">
						<i class="bi bi-star"></i> {% trans "Değerlendirme Ekle" %}
					</button>
					<a class="btn btn-sm btn-outline-primary" href="{% url 'suppliers_edit' supplier.id %}">
						<i class="bi bi-pencil"></i> {% trans "Düzenle" %}
					</a>
				{% endif %}
				<a class="btn btn-sm btn-outline-secondary" href="{% url 'suppliers_list' %}">
					<i class="bi bi-arrow-left"></i> {% trans "Geri" %}
				</a>
			</div>
		</div>
		<div class="card-body">
			<div class="row">
				<div class="col-md-4">
					<p class="mb-2">
						<strong>{% trans "Email:" %}</strong><br>
						<span class="text-muted">{{ supplier.email|default:"-" }}</span>
					</p>
				</div>
				<div class="col-md-4">
					<p class="mb-2">
						<strong>{% trans "Telefon:" %}</strong><br>
						<span class="text-muted">{{ supplier.phone|default:"-" }}</span>
					</p>
				</div>
				<div class="col-md-4">
					<p class="mb-2">
						<strong>{% trans "Kayıt Tarihi:" %}</strong><br>
						<span class="text-muted">{{ supplier.created_at|date:"Y-m-d H:i" }}</span>
					</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Performans Skoru ve Detaylı Analiz -->
	{% if has_metrics %}
	<div class="row mb-4">
		<!-- Ana Skor Kartı -->
		<div class="col-lg-4">
			<div class="card shadow-sm h-100 border-{{ badge_class }}">
				<div class="card-header bg-{{ badge_class }} text-white text-center">
					<h5 class="mb-0">
						<i class="bi bi-trophy-fill"></i> {% trans "Toplam Skor" %}
					</h5>
				</div>
				<div class="card-body text-center d-flex flex-column justify-content-center">
					<div class="display-1 fw-bold text-{{ badge_class }} mb-2">
						{{ metrics.overall_score|floatformat:1 }}
					</div>
					<div class="text-muted mb-3">/ 100</div>
					<span class="badge bg-{{ badge_class }} fs-5 mb-3">{{ badge_text }}</span>
					<div class="progress" style="height: 15px;">
						<div class="progress-bar bg-{{ badge_class }}" role="progressbar" 
							 style="width: {{ metrics.overall_score }}%;" 
							 aria-valuenow="{{ metrics.overall_score }}" aria-valuemin="0" aria-valuemax="100">
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Detaylı Metrikler -->
		<div class="col-lg-8">
			<div class="card shadow-sm h-100">
				<div class="card-header bg-light">
					<h5 class="mb-0">
						<i class="bi bi-graph-up"></i> {% trans "Performans Metrikleri" %}
					</h5>
				</div>
				<div class="card-body">
					<div class="row g-3">
						<!-- Kazanma Oranı -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-trophy text-warning"></i> {% trans "Kazanma Oranı" %}</span>
									<span class="fs-5 fw-bold text-primary">%{{ metrics.win_rate_percent|floatformat:1 }}</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-primary" style="width: {{ metrics.win_rate_percent }}%;"></div>
								</div>
								<small class="text-muted">{{ metrics.total_quotes_sent }} tekliften {{ metrics.total_wins }} kazanım</small>
							</div>
						</div>
						
						<!-- Teklif Hızı -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-clock text-info"></i> {% trans "Teklif Hızı" %}</span>
									<span class="fs-5 fw-bold text-info">{{ metrics.avg_quote_response_hours|floatformat:1 }}s</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-info" style="width: {% if metrics.avg_quote_response_hours <= 24 %}100{% elif metrics.avg_quote_response_hours <= 48 %}75{% elif metrics.avg_quote_response_hours <= 72 %}50{% else %}25{% endif %}%;"></div>
								</div>
								<small class="text-muted">Ortalama yanıt süresi</small>
							</div>
						</div>
						
						<!-- Zamanında Teslimat -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-calendar-check text-success"></i> {% trans "Zamanında Teslimat" %}</span>
									<span class="fs-5 fw-bold text-success">%{{ metrics.on_time_delivery_percent|floatformat:1 }}</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-success" style="width: {{ metrics.on_time_delivery_percent }}%;"></div>
								</div>
								<small class="text-muted">{{ metrics.on_time_deliveries }}/{{ metrics.total_deliveries }} teslimat</small>
							</div>
						</div>
						
						<!-- Ürün Kalitesi -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-star text-warning"></i> {% trans "Ürün Kalitesi" %}</span>
									<span class="fs-5 fw-bold text-warning">{{ metrics.avg_product_quality|floatformat:1 }}/5</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-warning" style="width: {% widthratio metrics.avg_product_quality 5 100 %}%;"></div>
								</div>
								<small class="text-muted">Müşteri değerlendirmesi</small>
							</div>
						</div>
						
						<!-- İletişim -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-chat-dots text-primary"></i> {% trans "İletişim" %}</span>
									<span class="fs-5 fw-bold text-primary">{{ metrics.avg_communication|floatformat:1 }}/5</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-primary" style="width: {% widthratio metrics.avg_communication 5 100 %}%;"></div>
								</div>
								<small class="text-muted">İletişim kalitesi</small>
							</div>
						</div>
						
						<!-- Müşteri Memnuniyeti -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-emoji-smile text-success"></i> {% trans "Memnuniyet" %}</span>
									<span class="fs-5 fw-bold text-success">{{ metrics.avg_overall_satisfaction|floatformat:1 }}/5</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-success" style="width: {% widthratio metrics.avg_overall_satisfaction 5 100 %}%;"></div>
								</div>
								<small class="text-muted">Genel memnuniyet</small>
							</div>
						</div>
					</div>
					
					<div class="mt-3 pt-3 border-top">
						<div class="row text-center">
							<div class="col-4">
								<div class="text-muted small">{% trans "Toplam Sipariş" %}</div>
								<div class="fs-4 fw-bold text-primary">{{ metrics.total_orders }}</div>
							</div>
							<div class="col-4">
								<div class="text-muted small">{% trans "Teklif Gönderildi" %}</div>
								<div class="fs-4 fw-bold text-info">{{ metrics.total_quotes_sent }}</div>
							</div>
							<div class="col-4">
								<div class="text-muted small">{% trans "Teslimat Yapıldı" %}</div>
								<div class="fs-4 fw-bold text-success">{{ metrics.total_deliveries }}</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Owner Değerlendirmeleri -->
	{% if review_stats %}
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-gradient-warning">
			<h5 class="mb-0">
				<i class="bi bi-star-fill text-warning"></i> {% trans "Yönetici Değerlendirmeleri" %}
			</h5>
		</div>
		<div class="card-body">
			<div class="row g-3">
				{% for category_code, stats in review_stats.items %}
				<div class="col-md-6 col-lg-4">
					<div class="review-stat-card p-3 border rounded">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<span class="fw-semibold">{{ stats.name }}</span>
							<span class="badge bg-warning">{{ stats.count }} değ.</span>
						</div>
						<div class="d-flex align-items-center gap-2">
							<div class="fs-3 fw-bold text-warning">{{ stats.avg }}</div>
							<div class="flex-grow-1">
								<div class="d-flex gap-1">
									{% for i in "12345" %}
									{% if i|add:"0" <= stats.avg %}
										<i class="bi bi-star-fill text-warning"></i>
									{% else %}
										<i class="bi bi-star text-muted"></i>
									{% endif %}
									{% endfor %}
								</div>
							</div>
						</div>
					</div>
				</div>
				{% endfor %}
			</div>
		</div>
	</div>
	{% endif %}
	{% endif %}

	<!-- İstatistikler -->
	<div class="row mb-4">
		<div class="col-md-4">
			<div class="card text-center">
				<div class="card-body">
					<h2 class="text-primary mb-0">{{ total_tickets }}</h2>
					<p class="text-muted mb-0">{% trans "Toplam Gönderilen İş" %}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card text-center">
				<div class="card-body">
					<h2 class="text-success mb-0">{{ tickets_with_quotes }}</h2>
					<p class="text-muted mb-0">{% trans "Teklif Verilen İş" %}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card text-center">
				<div class="card-body">
					<h2 class="text-warning mb-0">{{ tickets_without_quotes }}</h2>
					<p class="text-muted mb-0">{% trans "Teklif Bekleyen İş" %}</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Kabul Edilen Teklifler (Siparişler) -->
	{% if accepted_quotes %}
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-success text-white">
			<h5 class="mb-0">
				<i class="bi bi-check-circle"></i> {% trans "Kabul Edilen Teklifler (Siparişler)" %}
			</h5>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-sm table-hover">
					<thead class="table-light">
						<tr>
						<th>{% trans "Ticket #" %}</th>
						<th>{% trans "Müşteri" %}</th>
						<th>{% trans "Başlık" %}</th>
						<th>{% trans "Tutar" %}</th>
						<th>{% trans "Teklif Tarihi" %}</th>
						<th>{% trans "Durum" %}</th>
						</tr>
					</thead>
					<tbody>
					{% for quote in accepted_quotes %}
						<tr>
							<td>
								<a href="{% url 'ticket_detail_owner' quote.ticket.id %}" class="text-decoration-none">
									#{{ quote.ticket.id }}
								</a>
							</td>
							<td>{{ quote.ticket.customer.name }}</td>
							<td>{{ quote.ticket.title|truncatewords:8 }}</td>
							<td>
								<strong>{{ quote.amount }} {{ quote.currency }}</strong>
							</td>
							<td>
								<small class="text-muted">{{ quote.created_at|date:"Y-m-d H:i" }}</small>
							</td>
							<td>
								{% if quote.ticket.status == 'completed' %}
									<span class="badge bg-success">{% trans "Tamamlandı" %}</span>
								{% elif quote.ticket.status == 'in_progress' %}
									<span class="badge bg-info">{% trans "Devam Ediyor" %}</span>
								{% else %}
									<span class="badge bg-secondary">{{ quote.ticket.get_status_display }}</span>
								{% endif %}
							</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
	{% endif %}

	<!-- Gönderilen İşler -->
	<div class="card shadow-sm">
		<div class="card-header">
			<h5 class="mb-0">
				<i class="bi bi-list-task"></i> {% trans "Gönderilen Tüm İşler" %}
			</h5>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-sm table-hover">
					<thead class="table-light">
						<tr>
							<th>{% trans "Ticket #" %}</th>
							<th>{% trans "Müşteri" %}</th>
							<th>{% trans "Kategori" %}</th>
							<th>{% trans "Başlık" %}</th>
							<th>{% trans "Durum" %}</th>
							<th>{% trans "Teklif Durumu" %}</th>
							<th>{% trans "Teklif Tutarı" %}</th>
							<th>{% trans "Tarih" %}</th>
						</tr>
					</thead>
					<tbody>
					{% for td in ticket_data %}
						<tr>
							<td>
								<a href="{% url 'ticket_detail_owner' td.ticket.id %}" class="text-decoration-none">
									#{{ td.ticket.id }}
								</a>
							</td>
							<td>{{ td.ticket.customer.name }}</td>
							<td>
								<small class="text-muted">{{ td.ticket.category.name|default:"-" }}</small>
							</td>
							<td>{{ td.ticket.title|truncatewords:10 }}</td>
							<td>
								{% if td.ticket.status == 'completed' %}
									<span class="badge bg-success">{% trans "Tamamlandı" %}</span>
								{% elif td.ticket.status == 'in_progress' %}
									<span class="badge bg-info">{% trans "Devam Ediyor" %}</span>
								{% elif td.ticket.status == 'waiting_quote' %}
									<span class="badge bg-warning">{% trans "Teklif Bekleniyor" %}</span>
								{% elif td.ticket.status == 'quoted' %}
									<span class="badge bg-primary">{% trans "Teklif Verildi" %}</span>
								{% else %}
									<span class="badge bg-secondary">{{ td.ticket.get_status_display }}</span>
								{% endif %}
							</td>
						<td>
							{% if td.has_quote %}
								{% if td.ticket.selected_quote_id == td.quote.id %}
									<span class="badge bg-success">
										<i class="bi bi-check-circle"></i> {% trans "Kabul Edildi" %}
									</span>
								{% else %}
									<span class="badge bg-info">
										<i class="bi bi-file-text"></i> {% trans "Teklif Verildi" %}
									</span>
								{% endif %}
							{% else %}
								<span class="badge bg-warning">
									<i class="bi bi-clock"></i> {% trans "Teklif Bekleniyor" %}
								</span>
							{% endif %}
						</td>
							<td>
								{% if td.quote %}
									<strong>{{ td.quote.amount }} {{ td.quote.currency }}</strong>
								{% else %}
									<span class="text-muted">-</span>
								{% endif %}
							</td>
							<td>
								<small class="text-muted">{{ td.ticket.created_at|date:"Y-m-d" }}</small>
							</td>
						</tr>
					{% empty %}
						<tr>
							<td colspan="8" class="text-center text-muted py-4">
								{% trans "Bu tedarikçiye henüz iş gönderilmemiş." %}
							</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- Owner Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form method="post" action="{% url 'add_owner_review' %}">
				{% csrf_token %}
				<input type="hidden" name="supplier_id" value="{{ supplier.id }}">
				<input type="hidden" name="redirect_to" value="{{ request.path }}">
				
				<div class="modal-header bg-warning text-white">
					<h5 class="modal-title" id="reviewModalLabel">
						<i class="bi bi-star-fill"></i> {% trans "Tedarikçiyi Değerlendir" %}
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				
				<div class="modal-body compact-rating-modal">
					<!-- Güvenilirlik -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "Güvenilirlik" %}</small>
							<div class="star-group d-flex gap-1" data-category="reliability">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_reliability" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<!-- İletişim -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "İletişim" %}</small>
							<div class="star-group d-flex gap-1" data-category="communication">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_communication" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<!-- Kalite -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "Kalite" %}</small>
							<div class="star-group d-flex gap-1" data-category="quality">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_quality" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<!-- Ödeme -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "Ödeme" %}</small>
							<div class="star-group d-flex gap-1" data-category="payment">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_payment" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<!-- Fiyatlandırma -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "Fiyatlandırma" %}</small>
							<div class="star-group d-flex gap-1" data-category="pricing">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_pricing" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<div class="invalid-feedback d-none text-center mt-2" id="rating-error">
						<small>{% trans "Lütfen en az bir kategori için puan verin" %}</small>
					</div>
					
					<div class="mt-3">
						<textarea name="comment" class="form-control form-control-sm" rows="2" placeholder="{% trans 'Yorum (Opsiyonel)' %}"></textarea>
					</div>
				</div>
				
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						{% trans "İptal" %}
					</button>
					<button type="submit" class="btn btn-warning">
						<i class="bi bi-save"></i> {% trans "Kaydet" %}
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<style>
.compact-rating-modal {
	padding: 1rem 1.25rem !important;
}
.rating-item {
	padding: 0.5rem 0;
	border-bottom: 1px solid #e9ecef;
}
.rating-item:last-of-type {
	border-bottom: none;
}
.rating-item:hover {
	background-color: #f8f9fa;
	padding-left: 0.5rem;
	padding-right: 0.5rem;
	margin-left: -0.5rem;
	margin-right: -0.5rem;
	border-radius: 4px;
}
.star-group .star-item i.bi-star-fill {
	color: #ffd700 !important;
}
.star-group .star-item i.bi-star {
	color: #c4c4c4 !important;
	transition: all 0.15s ease;
}
.star-group .star-item:hover i {
	transform: scale(1.15);
}
.invalid-feedback.d-block {
	display: block !important;
	color: #dc3545;
	font-size: 0.875rem;
	font-weight: 500;
}
</style>

<script>
// Category star rating system
document.addEventListener('DOMContentLoaded', function() {
	const starGroups = document.querySelectorAll('.star-group');
	const ratingError = document.getElementById('rating-error');
	const reviewForm = document.getElementById('ownerReviewForm');
	
	// Track ratings for each category
	const categoryRatings = {};
	
	starGroups.forEach(group => {
		const category = group.dataset.category;
		const stars = group.querySelectorAll('.star-item');
		categoryRatings[category] = 0;
		
		stars.forEach((star, index) => {
			const starIcon = star.querySelector('i');
			const input = star.querySelector('input');
			
			// Click to select
			star.addEventListener('click', function() {
				categoryRatings[category] = index + 1;
				input.checked = true;
				updateStarsInGroup(stars, categoryRatings[category]);
				
				// Hide error when any rating is selected
				if(ratingError) {
					ratingError.classList.add('d-none');
				}
			});
			
			// Hover effect
			star.addEventListener('mouseenter', function() {
				for(let i = 0; i <= index; i++) {
					stars[i].querySelector('i').classList.remove('bi-star');
					stars[i].querySelector('i').classList.add('bi-star-fill');
				}
			});
		});
		
		// Reset on mouse leave
		group.addEventListener('mouseleave', function() {
			updateStarsInGroup(stars, categoryRatings[category]);
		});
	});
	
	// Form validation
	if(reviewForm) {
		reviewForm.addEventListener('submit', function(e) {
			const hasAnyRating = Object.values(categoryRatings).some(rating => rating > 0);
			
			if(!hasAnyRating) {
				e.preventDefault();
				if(ratingError) {
					ratingError.classList.remove('d-none');
					ratingError.classList.add('d-block');
				}
				// Scroll to first category
				document.querySelector('.category-rating-row').scrollIntoView({ behavior: 'smooth', block: 'center' });
				return false;
			}
		});
	}
	
	function updateStarsInGroup(stars, selectedRating) {
		stars.forEach((star, index) => {
			const icon = star.querySelector('i');
			if(index < selectedRating) {
				icon.classList.remove('bi-star');
				icon.classList.add('bi-star-fill');
			} else {
				icon.classList.remove('bi-star-fill');
				icon.classList.add('bi-star');
			}
		});
	}
});
</script>
{% endblock %}
