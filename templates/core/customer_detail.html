{% extends "base.html" %}
{% load i18n %}

{% block content %}
<div class="container-fluid">
	<!-- Müşteri Başlık -->
	<div class="card shadow-sm mb-4">
		<div class="card-header d-flex justify-content-between align-items-center">
			<h4 class="mb-0">
				<i class="bi bi-person-circle"></i> {{ customer.name }}
			</h4>
			<div>
				{% if 'customers_edit' in tenant_permissions %}
					<button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#reviewModal">
						<i class="bi bi-star"></i> {% trans "Değerlendirme Ekle" %}
					</button>
					<a class="btn btn-sm btn-outline-primary" href="{% url 'customers_edit' customer.id %}">
						<i class="bi bi-pencil"></i> {% trans "Düzenle" %}
					</a>
				{% endif %}
				<a class="btn btn-sm btn-outline-secondary" href="{% url 'customers_list' %}">
					<i class="bi bi-arrow-left"></i> {% trans "Geri" %}
				</a>
			</div>
		</div>
		<div class="card-body">
			<div class="row">
				<div class="col-md-4">
					<p class="mb-2">
						<strong>{% trans "Email:" %}</strong><br>
						<span class="text-muted">{{ customer.email|default:"-" }}</span>
					</p>
				</div>
				<div class="col-md-4">
					<p class="mb-2">
						<strong>{% trans "Telefon:" %}</strong><br>
						<span class="text-muted">{{ customer.phone|default:"-" }}</span>
					</p>
				</div>
				<div class="col-md-4">
					<p class="mb-2">
						<strong>{% trans "Kayıt Tarihi:" %}</strong><br>
						<span class="text-muted">{{ customer.created_at|date:"Y-m-d H:i" }}</span>
					</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Performans Skoru ve Detaylı Analiz -->
	{% if has_metrics %}
	<div class="row mb-4">
		<!-- Ana Skor Kartı -->
		<div class="col-lg-4">
			<div class="card shadow-sm h-100 border-{{ badge_class }}">
				<div class="card-header bg-{{ badge_class }} text-white text-center">
					<h5 class="mb-0">
						<i class="bi bi-trophy-fill"></i> {% trans "Müşteri Skoru" %}
					</h5>
				</div>
				<div class="card-body text-center d-flex flex-column justify-content-center">
					<div class="display-1 fw-bold text-{{ badge_class }} mb-2">
						{{ metrics.overall_score|floatformat:1 }}
					</div>
					<div class="text-muted mb-3">/ 100</div>
					<span class="badge bg-{{ badge_class }} fs-5 mb-3">{{ badge_text }}</span>
					<div class="progress" style="height: 15px;">
						<div class="progress-bar bg-{{ badge_class }}" role="progressbar" 
							 style="width: {{ metrics.overall_score }}%;" 
							 aria-valuenow="{{ metrics.overall_score }}" aria-valuemin="0" aria-valuemax="100">
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Detaylı Metrikler -->
		<div class="col-lg-8">
			<div class="card shadow-sm h-100">
				<div class="card-header bg-light">
					<h5 class="mb-0">
						<i class="bi bi-graph-up"></i> {% trans "Müşteri Performansı" %}
					</h5>
				</div>
				<div class="card-body">
					<div class="row g-3">
						<!-- Dönüşüm Oranı -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-bag-check text-success"></i> {% trans "Dönüşüm Oranı" %}</span>
									<span class="fs-5 fw-bold text-success">%{{ metrics.conversion_rate_percent|floatformat:1 }}</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-success" style="width: {{ metrics.conversion_rate_percent }}%;"></div>
								</div>
								<small class="text-muted">{{ metrics.total_orders }}/{{ metrics.total_tickets }} sipariş</small>
							</div>
						</div>
						
						<!-- İptal Oranı -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-x-circle text-danger"></i> {% trans "İptal Oranı" %}</span>
									<span class="fs-5 fw-bold text-danger">%{{ metrics.cancellation_rate_percent|floatformat:1 }}</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-danger" style="width: {{ metrics.cancellation_rate_percent }}%;"></div>
								</div>
								<small class="text-muted">{{ metrics.total_cancellations }} iptal</small>
							</div>
						</div>
						
						<!-- Yanıt Süresi -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-clock text-info"></i> {% trans "Yanıt Hızı" %}</span>
									<span class="fs-5 fw-bold text-info">{{ metrics.avg_response_hours|floatformat:1 }}s</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-info" style="width: {% if metrics.avg_response_hours <= 24 %}100{% elif metrics.avg_response_hours <= 48 %}75{% elif metrics.avg_response_hours <= 72 %}50{% else %}25{% endif %}%;"></div>
								</div>
								<small class="text-muted">Ortalama yanıt süresi</small>
							</div>
						</div>
						
						<!-- Toplam Harcama -->
						<div class="col-md-6">
							<div class="metric-card p-3 border rounded">
								<div class="d-flex justify-content-between align-items-center mb-2">
									<span class="fw-semibold"><i class="bi bi-currency-dollar text-primary"></i> {% trans "Toplam Harcama" %}</span>
									<span class="fs-5 fw-bold text-primary">{{ metrics.total_spending_score|floatformat:0 }}</span>
								</div>
								<div class="progress" style="height: 8px;">
									<div class="progress-bar bg-primary" style="width: {% widthratio metrics.total_spending_score 100 100 %}%;"></div>
								</div>
								<small class="text-muted">Harcama puanı</small>
							</div>
						</div>
					</div>
					
					<div class="mt-3 pt-3 border-top">
						<div class="row text-center">
							<div class="col-4">
								<div class="text-muted small">{% trans "Toplam Talep" %}</div>
								<div class="fs-4 fw-bold text-primary">{{ metrics.total_tickets }}</div>
							</div>
							<div class="col-4">
								<div class="text-muted small">{% trans "Sipariş" %}</div>
								<div class="fs-4 fw-bold text-success">{{ metrics.total_orders }}</div>
							</div>
							<div class="col-4">
								<div class="text-muted small">{% trans "İptal" %}</div>
								<div class="fs-4 fw-bold text-danger">{{ metrics.total_cancellations }}</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Owner Değerlendirmeleri -->
	{% if review_stats %}
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-gradient-warning">
			<h5 class="mb-0">
				<i class="bi bi-star-fill text-warning"></i> {% trans "Yönetici Değerlendirmeleri" %}
			</h5>
		</div>
		<div class="card-body">
			<div class="row g-3">
				{% for category_code, stats in review_stats.items %}
				<div class="col-md-6 col-lg-4">
					<div class="review-stat-card p-3 border rounded">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<span class="fw-semibold">{{ stats.name }}</span>
							<span class="badge bg-warning">{{ stats.count }} değ.</span>
						</div>
						<div class="d-flex align-items-center gap-2">
							<div class="fs-3 fw-bold text-warning">{{ stats.avg }}</div>
							<div class="flex-grow-1">
								<div class="d-flex gap-1">
									{% for i in "12345" %}
									{% if i|add:"0" <= stats.avg %}
										<i class="bi bi-star-fill text-warning"></i>
									{% else %}
										<i class="bi bi-star text-muted"></i>
									{% endif %}
									{% endfor %}
								</div>
							</div>
						</div>
					</div>
				</div>
				{% endfor %}
			</div>
		</div>
	</div>
	{% endif %}
	{% endif %}

	<!-- İstatistikler -->
	<div class="row mb-4">
		<div class="col-md-4">
			<div class="card text-center">
				<div class="card-body">
					<h2 class="text-primary mb-0">{{ total_tickets }}</h2>
					<p class="text-muted mb-0">{% trans "Toplam Talep" %}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card text-center">
				<div class="card-body">
					<h2 class="text-success mb-0">{{ tickets_with_orders }}</h2>
					<p class="text-muted mb-0">{% trans "Siparişe Dönüşen" %}</p>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card text-center">
				<div class="card-body">
					<h2 class="text-info mb-0">{{ total_quotes_received }}</h2>
					<p class="text-muted mb-0">{% trans "Alınan Teklif" %}</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Siparişler -->
	{% if orders %}
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-success text-white">
			<h5 class="mb-0">
				<i class="bi bi-bag-check"></i> {% trans "Siparişler" %}
			</h5>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-sm table-hover">
					<thead class="table-light">
						<tr>
							<th>{% trans "Ticket #" %}</th>
							<th>{% trans "Kategori" %}</th>
							<th>{% trans "Tedarikçi" %}</th>
							<th>{% trans "Durum" %}</th>
							<th>{% trans "Tarih" %}</th>
						</tr>
					</thead>
					<tbody>
					{% for order in orders %}
						<tr>
							<td>
								<a href="{% url 'ticket_detail_owner' order.ticket.id %}">#{{ order.ticket.id }}</a>
							</td>
							<td>{{ order.ticket.category.name }}</td>
							<td>
								<a href="{% url 'supplier_detail' order.supplier.id %}">{{ order.supplier.name }}</a>
							</td>
							<td>
								{% if order.status == 'pending' %}
									<span class="badge bg-warning">{% trans "Bekliyor" %}</span>
								{% elif order.status == 'confirmed' %}
									<span class="badge bg-info">{% trans "Onaylandı" %}</span>
								{% elif order.status == 'shipped' %}
									<span class="badge bg-primary">{% trans "Gönderildi" %}</span>
								{% elif order.status == 'completed' %}
									<span class="badge bg-success">{% trans "Tamamlandı" %}</span>
								{% elif order.status == 'cancelled' %}
									<span class="badge bg-danger">{% trans "İptal" %}</span>
								{% endif %}
							</td>
							<td><small class="text-muted">{{ order.created_at|date:"Y-m-d" }}</small></td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
	{% endif %}

	<!-- Talepler (Tickets) -->
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-light">
			<h5 class="mb-0">
				<i class="bi bi-ticket-detailed"></i> {% trans "Tüm Talepler" %}
			</h5>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-sm table-hover">
					<thead class="table-light">
						<tr>
							<th>{% trans "Ticket #" %}</th>
							<th>{% trans "Kategori" %}</th>
							<th>{% trans "Başlık" %}</th>
							<th>{% trans "Teklif Sayısı" %}</th>
							<th>{% trans "Durum" %}</th>
							<th>{% trans "Tarih" %}</th>
						</tr>
					</thead>
					<tbody>
					{% for td in ticket_data %}
						<tr>
							<td>
								<a href="{% url 'ticket_detail_owner' td.ticket.id %}">#{{ td.ticket.id }}</a>
							</td>
							<td>{{ td.ticket.category.name }}</td>
							<td>{{ td.ticket.title|truncatewords:8 }}</td>
							<td class="text-center">
								<span class="badge bg-info">{{ td.quotes_count }}</span>
							</td>
							<td>
								{% if td.has_order %}
									<span class="badge bg-success">{% trans "Sipariş Verildi" %}</span>
								{% elif td.quotes_count > 0 %}
									<span class="badge bg-warning">{% trans "Teklif Alındı" %}</span>
								{% else %}
									<span class="badge bg-secondary">{% trans "Teklif Bekleniyor" %}</span>
								{% endif %}
							</td>
							<td><small class="text-muted">{{ td.ticket.created_at|date:"Y-m-d" }}</small></td>
						</tr>
					{% empty %}
						<tr>
							<td colspan="6" class="text-center text-muted py-4">
								{% trans "Bu müşteriye henüz talep oluşturulmamış." %}
							</td>
						</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- Owner Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form method="post" action="{% url 'add_owner_review' %}" id="ownerReviewForm">
				{% csrf_token %}
				<input type="hidden" name="customer_id" value="{{ customer.id }}">
				<input type="hidden" name="redirect_to" value="{{ request.path }}">
				
				<div class="modal-header bg-warning text-white">
					<h5 class="modal-title" id="reviewModalLabel">
						<i class="bi bi-star-fill"></i> {% trans "Müşteriyi Değerlendir" %}
					</h5>
					<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				
				<div class="modal-body compact-rating-modal">
					<!-- Güvenilirlik -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "Güvenilirlik" %}</small>
							<div class="star-group d-flex gap-1" data-category="reliability">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_reliability" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<!-- İletişim -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "İletişim" %}</small>
							<div class="star-group d-flex gap-1" data-category="communication">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_communication" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<!-- Kalite -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "Kalite" %}</small>
							<div class="star-group d-flex gap-1" data-category="quality">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_quality" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<!-- Ödeme -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "Ödeme" %}</small>
							<div class="star-group d-flex gap-1" data-category="payment">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_payment" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<!-- Fiyatlandırma -->
					<div class="rating-item">
						<div class="d-flex justify-content-between align-items-center">
							<small class="fw-semibold">{% trans "Fiyatlandırma" %}</small>
							<div class="star-group d-flex gap-1" data-category="pricing">
								{% for i in "12345" %}
								<label class="star-item" data-value="{{ i }}">
									<input type="radio" name="rating_pricing" value="{{ i }}" style="display: none;">
									<i class="bi bi-star" style="font-size: 1.2rem; cursor: pointer; color: #c4c4c4;"></i>
								</label>
								{% endfor %}
							</div>
						</div>
					</div>
					
					<div class="invalid-feedback d-none text-center mt-2" id="rating-error">
						<small>{% trans "Lütfen en az bir kategori için puan verin" %}</small>
					</div>
					
					<div class="mt-3">
						<textarea name="comment" class="form-control form-control-sm" rows="2" placeholder="{% trans 'Yorum (Opsiyonel)' %}"></textarea>
					</div>
				</div>
				
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						{% trans "İptal" %}
					</button>
					<button type="submit" class="btn btn-warning">
						<i class="bi bi-save"></i> {% trans "Kaydet" %}
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<style>
.compact-rating-modal {
	padding: 1rem 1.25rem !important;
}
.rating-item {
	padding: 0.5rem 0;
	border-bottom: 1px solid #e9ecef;
}
.rating-item:last-of-type {
	border-bottom: none;
}
.rating-item:hover {
	background-color: #f8f9fa;
	padding-left: 0.5rem;
	padding-right: 0.5rem;
	margin-left: -0.5rem;
	margin-right: -0.5rem;
	border-radius: 4px;
}
.star-group .star-item i.bi-star-fill {
	color: #ffd700 !important;
}
.star-group .star-item i.bi-star {
	color: #c4c4c4 !important;
	transition: all 0.15s ease;
}
.star-group .star-item:hover i {
	transform: scale(1.15);
}
.invalid-feedback.d-block {
	display: block !important;
	color: #dc3545;
	font-size: 0.875rem;
	font-weight: 500;
}
</style>

<script>
// Category star rating system
document.addEventListener('DOMContentLoaded', function() {
	const starGroups = document.querySelectorAll('.star-group');
	const ratingError = document.getElementById('rating-error');
	const reviewForm = document.getElementById('ownerReviewForm');
	
	// Track ratings for each category
	const categoryRatings = {};
	
	starGroups.forEach(group => {
		const category = group.dataset.category;
		const stars = group.querySelectorAll('.star-item');
		categoryRatings[category] = 0;
		
		stars.forEach((star, index) => {
			const starIcon = star.querySelector('i');
			const input = star.querySelector('input');
			
			// Click to select
			star.addEventListener('click', function() {
				categoryRatings[category] = index + 1;
				input.checked = true;
				updateStarsInGroup(stars, categoryRatings[category]);
				
				// Hide error when any rating is selected
				if(ratingError) {
					ratingError.classList.add('d-none');
				}
			});
			
			// Hover effect
			star.addEventListener('mouseenter', function() {
				for(let i = 0; i <= index; i++) {
					stars[i].querySelector('i').classList.remove('bi-star');
					stars[i].querySelector('i').classList.add('bi-star-fill');
				}
			});
		});
		
		// Reset on mouse leave
		group.addEventListener('mouseleave', function() {
			updateStarsInGroup(stars, categoryRatings[category]);
		});
	});
	
	// Form validation
	if(reviewForm) {
		reviewForm.addEventListener('submit', function(e) {
			const hasAnyRating = Object.values(categoryRatings).some(rating => rating > 0);
			
			if(!hasAnyRating) {
				e.preventDefault();
				if(ratingError) {
					ratingError.classList.remove('d-none');
					ratingError.classList.add('d-block');
				}
				// Scroll to first category
				document.querySelector('.rating-item').scrollIntoView({ behavior: 'smooth', block: 'center' });
				return false;
			}
		});
	}
	
	function updateStarsInGroup(stars, selectedRating) {
		stars.forEach((star, index) => {
			const icon = star.querySelector('i');
			if(index < selectedRating) {
				icon.classList.remove('bi-star');
				icon.classList.add('bi-star-fill');
			} else {
				icon.classList.remove('bi-star-fill');
				icon.classList.add('bi-star');
			}
		});
	}
});
</script>
{% endblock %}
