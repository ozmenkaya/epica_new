{% extends "base.html" %}
{% load i18n %}
{% load form_tags %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">{{ org.name }} - {% trans "Tedarikçi" %}</h5>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'suppliers_list' %}">{% trans "Listeye Dön" %}</a>
  </div>
  <div class="card-body">
    {% if show_confirmation %}
      <div class="alert alert-warning">
        <h6><i class="bi bi-exclamation-triangle"></i> {% trans "Mevcut Tedarikçi Bulundu" %}</h6>
        <p class="mb-2">
          <strong>{{ existing_supplier.name }}</strong> ({{ existing_supplier.email }}) {% trans "isimli tedarikçi sistemde zaten kayıtlı." %}
        </p>
        <p class="mb-3">
          {% trans "Bu tedarikçiyi organizasyonunuza eklemek istiyor musunuz?" %}
        </p>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="confirm_add_existing" value="yes">
          <input type="hidden" name="existing_supplier_id" value="{{ existing_supplier.id }}">
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-warning">
              <i class="bi bi-plus-circle"></i> Evet, Bu Tedarikçiyi Ekle
            </button>
            <a href="{% url 'suppliers_list' %}" class="btn btn-outline-secondary">İptal</a>
          </div>
        </form>
      </div>
    {% else %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger mb-3">
          {{ form.non_field_errors }}
        </div>
      {% endif %}
      <div id="existing-supplier-alert" class="alert alert-info d-none mb-3">
        <i class="bi bi-info-circle"></i>
        <span id="existing-supplier-message"></span>
      </div>
      <form method="post" novalidate id="supplier-form">
        {% csrf_token %}
        {% for field in form %}
          {% bootstrap_field field %}
        {% endfor %}
        <div class="d-flex gap-2">
          <button class="btn btn-primary" type="submit">{% trans "Kaydet" %}</button>
          <a class="btn btn-outline-secondary" href="{% url 'suppliers_list' %}">{% trans "İptal" %}</a>
        </div>
      </form>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const emailInput = document.getElementById('id_email');
  const alertBox = document.getElementById('existing-supplier-alert');
  const alertMessage = document.getElementById('existing-supplier-message');
  const loginFields = ['id_login_username', 'id_login_password1', 'id_login_password2'];
  const submitBtn = document.querySelector('#supplier-form button[type="submit"]');
  
  // Ensure submit button is enabled on page load
  if (submitBtn) submitBtn.disabled = false;
  
  if (emailInput) {
    emailInput.addEventListener('blur', function() {
      const email = this.value.trim();
      if (!email) {
        alertBox.classList.add('d-none');
        showLoginFields();
        return;
      }
      
      // Check if supplier exists via AJAX
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      fetch('{% url "check_supplier_email" %}?email=' + encodeURIComponent(email), {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrftoken
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(data => {
        if (data.exists) {
          alertMessage.textContent = 'Bu email adresiyle "' + data.name + '" isimli tedarikçi zaten mevcut. Kaydedildiğinde bu tedarikçi organizasyonunuza eklenecek.';
          alertBox.classList.remove('d-none');
          alertBox.classList.remove('alert-info');
          alertBox.classList.add('alert-warning');
          hideLoginFields();
        } else {
          alertBox.classList.add('d-none');
          showLoginFields();
        }
      })
      .catch(error => {
        console.error('Error checking email:', error);
        alertBox.classList.add('d-none');
        showLoginFields();
      });
    });
  }
  
  function hideLoginFields() {
    loginFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        const formGroup = field.closest('.mb-3');
        if (formGroup) formGroup.style.display = 'none';
        // Clear the field value to prevent validation issues
        field.value = '';
        field.classList.remove('is-invalid', 'is-valid');
      }
    });
    // Clear username feedback and enable submit button
    const feedbackDiv = document.getElementById('username-feedback');
    if (feedbackDiv) feedbackDiv.innerHTML = '';
    if (submitBtn) submitBtn.disabled = false;
  }
  
  function showLoginFields() {
    loginFields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        const formGroup = field.closest('.mb-3');
        if (formGroup) formGroup.style.display = '';
      }
    });
  }
  
  // Username availability check
  const usernameInput = document.getElementById('id_login_username');
  
  if (usernameInput) {
    // Create feedback element
    const feedbackDiv = document.createElement('div');
    feedbackDiv.id = 'username-feedback';
    feedbackDiv.className = 'mt-1';
    usernameInput.parentNode.appendChild(feedbackDiv);
    
    let debounceTimer;
    
    usernameInput.addEventListener('input', function() {
      clearTimeout(debounceTimer);
      const username = this.value.trim();
      
      if (!username) {
        feedbackDiv.innerHTML = '';
        usernameInput.classList.remove('is-invalid', 'is-valid');
        if (submitBtn) submitBtn.disabled = false;
        return;
      }
      
      debounceTimer = setTimeout(function() {
        // Get current user id if editing existing supplier
        const excludeUserId = '{{ obj.user.id|default:"" }}';
        let url = '{% url "check_username" %}?username=' + encodeURIComponent(username);
        if (excludeUserId) {
          url += '&exclude_user_id=' + excludeUserId;
        }
        
        fetch(url, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
          if (data.exists) {
            feedbackDiv.innerHTML = '<small class="text-danger"><i class="bi bi-x-circle"></i> ' + data.message + '</small>';
            usernameInput.classList.add('is-invalid');
            usernameInput.classList.remove('is-valid');
            if (submitBtn) submitBtn.disabled = true;
          } else {
            feedbackDiv.innerHTML = '<small class="text-success"><i class="bi bi-check-circle"></i> Kullanılabilir</small>';
            usernameInput.classList.add('is-valid');
            usernameInput.classList.remove('is-invalid');
            if (submitBtn) submitBtn.disabled = false;
          }
        })
        .catch(err => {
          console.error('Username check error:', err);
          feedbackDiv.innerHTML = '';
          if (submitBtn) submitBtn.disabled = false;
        });
      }, 400);
    });
  }
});
</script>
{% endblock %}
